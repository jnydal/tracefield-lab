name: Build, Test, and Deploy

on: [push, pull_request, workflow_dispatch]

permissions:
  contents: read
  packages: write

jobs:
  api-image:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/test.Dockerfile
          push: false
          load: true
          tags: astro-test:ci

      - name: Run astro tests
        run: docker run --rm -v "${{ github.workspace }}:/app" -w /app astro-test:ci pytest -q --cov=service --cov-report=term-missing --cov-report=xml:coverage.xml

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: coverage.xml

      - name: Log in to GHCR
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push API image
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: api_build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./service/api/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/api:main
            ghcr.io/${{ github.repository }}/api:latest
            ghcr.io/${{ github.repository }}/api:${{ github.sha }}
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Write deploy manifest
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          mkdir -p deploy
          cat <<'EOF' > deploy/manifest.json
          {
            "image": "ghcr.io/${{ github.repository }}/api",
            "tags": ["main", "latest", "${{ github.sha }}"],
            "digest": "${{ steps.api_build.outputs.digest }}",
            "commit": "${{ github.sha }}",
            "run_id": "${{ github.run_id }}",
            "built_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

      - name: Upload deploy manifest
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: deploy-manifest
          path: deploy/manifest.json

  frontend-image:
    runs-on: ubuntu-latest
    needs: api-image
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push frontend image
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: frontend_build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/frontend:main
            ghcr.io/${{ github.repository }}/frontend:latest
            ghcr.io/${{ github.repository }}/frontend:${{ github.sha }}
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}

  worker-ingest-image:
    runs-on: ubuntu-latest
    needs: api-image
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to GHCR
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push worker-ingest image
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./service/worker_ingest/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/worker-ingest:main
            ghcr.io/${{ github.repository }}/worker-ingest:latest
            ghcr.io/${{ github.repository }}/worker-ingest:${{ github.sha }}
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}

  worker-embeddings-image:
    runs-on: ubuntu-latest
    needs: api-image
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to GHCR
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push worker-embeddings image
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./service/worker_embeddings/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/worker-embeddings:main
            ghcr.io/${{ github.repository }}/worker-embeddings:latest
            ghcr.io/${{ github.repository }}/worker-embeddings:${{ github.sha }}
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}

  resolver-image:
    runs-on: ubuntu-latest
    needs: api-image
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to GHCR
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push resolver image
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./service/resolver/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/resolver:main
            ghcr.io/${{ github.repository }}/resolver:latest
            ghcr.io/${{ github.repository }}/resolver:${{ github.sha }}
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
